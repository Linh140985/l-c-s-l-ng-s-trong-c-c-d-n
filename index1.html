<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trộn dàn & lọc theo tỷ lệ xuất hiện (00–99)</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --muted:#9aa4b2; --text:#e8edf3; --accent:#5cc8ff; --accent2:#8bffbd; --danger:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px} h1{font-size:22px;margin:0 0 16px;font-weight:700}
    .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr} .card{background:var(--card);border:1px solid #1f2630;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px} textarea{width:100%;min-height:240px;resize:vertical;background:#0f1319;border:1px solid #1f2630;border-radius:12px;padding:12px;color:var(--text);font:13px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}.row>*{flex:1 1 auto}
    input[type="number"],input[type="text"]{width:100%;background:#0f1319;border:1px solid #1f2630;border-radius:10px;padding:8px 10px;color:var(--text);font-size:14px}
    input[type="range"]{width:100%}.small{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid #273041;background:linear-gradient(180deg,#18202a,#12161c);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#364258}.btn.primary{border-color:#1c6fad;background:linear-gradient(180deg,#1a68a3,#144a74)}.btn.ghost{background:transparent;border-color:#273041}
    .pill{display:inline-block;padding:4px 8px;border-radius:20px;background:#0f1319;border:1px solid #273041;color:#cbd5e1;font-size:12px}
    .stack{display:flex;flex-direction:column;gap:10px}.stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpi{background:#0f1319;border:1px solid #273041;border-radius:12px;padding:10px;text-align:center}.kpi .v{font-weight:800;font-size:20px}
    .outbox{background:#0f1319;border:1px solid #273041;border-radius:12px;padding:10px}.outbox pre{margin:0;white-space:pre-wrap;word-wrap:break-word}
    table{width:100%;border-collapse:collapse;background:#0f1319;border:1px solid #273041;border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2630;text-align:left;font-size:13px} th{position:sticky;top:0;background:#141a21;z-index:1}
    .right{text-align:right}.ok{color:var(--accent2);font-weight:700}.warn{color:var(--danger);font-weight:700}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Trộn dàn & lọc theo tỷ lệ xuất hiện (00–99)</h1>

    <div class="grid">
      <section class="card stack">
        <div>
          <label><b>Dán dàn số</b> (mỗi dàn một dòng • số cách nhau bằng dấu phẩy/space). Ví dụ:
            <span class="pill">16, 83, 06, 98, 75, 41, 04, 95, …</span>
          </label>
          <textarea id="input" placeholder="dàn 1: 16, 83, 06, 98, 75, ...&#10;dàn 2: 00, 01, 02, ...&#10;...&#10;Hoặc ngăn cách dàn bằng dấu chấm '.'"></textarea>
          <div class="small">Tự bỏ “dàn x:”, chuẩn hoá 2 chữ số (00–99), bỏ trùng trong cùng dàn.</div>
        </div>

        <div class="row">
          <div class="stack">
            <label>Ngưỡng % (≥ floor(n × %))</label>
            <input id="thr" type="range" min="0" max="1" step="0.01" value="0.8" />
            <div class="row" style="align-items:center">
              <div class="pill" style="flex:0 0 auto"><span id="thrPct">80%</span></div>
              <div class="small" style="flex:1 1 auto">Kéo để đổi 70/80/85/90%…</div>
            </div>
          </div>
          <div class="stack">
            <label>Hoặc đặt theo <b>Số dàn tối thiểu</b> (ưu tiên nếu nhập)</label>
            <input id="minTimes" type="number" min="0" step="1" placeholder="vd 16 (nếu có 20 dàn để lấy ≥80%)" />
            <div class="small">Để trống nếu dùng theo %.</div>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="run">Tính dàn</button>
          <button class="btn" id="copy">Copy dàn kết quả</button>
          <button class="btn ghost" id="csv">Tải CSV</button>
        </div>
      </section>

      <section class="card stack">
        <div class="stats">
          <div class="kpi"><div class="small">Số dàn nhận</div><div class="v" id="kpiN">0</div></div>
          <div class="kpi"><div class="small">Ngưỡng (số lần)</div><div class="v" id="kpiMin">0</div></div>
          <div class="kpi"><div class="small">Số đạt ngưỡng</div><div class="v" id="kpiHit">0</div></div>
          <div class="kpi"><div class="small">Tỉ lệ trung vị</div><div class="v" id="kpiMed">–</div></div>
        </div>
        <div class="outbox">
          <div class="small">Dàn kết quả <span class="pill" id="outCount">0 số</span>:</div>
          <pre id="out">(chưa có)</pre>
        </div>
        <div class="small">Gợi ý: nếu muốn “cho phép tối đa b dàn xấu”, hãy đặt ngưỡng = <b>n − b</b> ở ô “Số dàn tối thiểu”.</div>
      </section>
    </div>

    <section class="card" style="margin-top:16px;">
      <div class="row" style="justify-content:space-between; align-items:baseline;">
        <h2 style="margin:0; font-size:18px;">Bảng tần suất (00–99)</h2>
        <span class="small">Chỉ hiển thị các số xuất hiện ≥ 1 lần.</span>
      </div>
      <div style="max-height:420px; overflow:auto; margin-top:8px;">
        <table id="tbl">
          <thead><tr>
            <th>Số</th><th class="right">Số lần</th><th class="right">Tỉ lệ</th><th class="right">Đạt ngưỡng</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const input = $('#input'), thr = $('#thr'), thrPct = $('#thrPct'), minTimesEl = $('#minTimes');
    const runBtn = $('#run'), copyBtn = $('#copy'), csvBtn = $('#csv');
    const kpiN = $('#kpiN'), kpiMin = $('#kpiMin'), kpiHit = $('#kpiHit'), kpiMed = $('#kpiMed');
    const out = $('#out'), tblBody = document.querySelector('#tbl tbody');

    thr.addEventListener('input', () => { thrPct.textContent = Math.round(thr.value*100)+'%'; run(); });

    function pad2(n){ n = Number(n); if(!Number.isFinite(n)||n<0||n>99) return null; return n.toString().padStart(2,'0'); }

    // Cho phép ngăn cách dàn bằng: xuống dòng, dấu . , hoặc tiền tố "dàn x:"
    function splitDans(raw){
      let t = raw.replace(/\r\n?/g, '\n').replace(/[。．]/g, '.');
      t = t.replace(/\bd[àa]n\s*\d+\s*:/ig, '\n');
      t = t.replace(/\.+/g, '.').replace(/\./g, '\n');
      return t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    }

    function cleanLine(line){
      return line.replace(/^\s*d[àa]n\s*\d+\s*:\s*/i,'').replace(/^\s*d[àa]n\s*:*/i,'');
    }

    function parse(raw){
      const chunks = splitDans(raw);
      const sets = [];
      for(const ch of chunks){
        const s = new Set();
        const tokens = cleanLine(ch).split(/[, \t]+/);
        for(let tok of tokens){
          tok = tok.trim(); if(!tok) continue;
          const v = pad2(tok); if(v!==null) s.add(v);
        }
        if(s.size>0) sets.push([...s]);
      }
      return sets;
    }

    function analyze(sets, minTimes){
      const n = sets.length, freq = new Map();
      for(const arr of sets) for(const v of arr) freq.set(v,(freq.get(v)||0)+1);
      const rows = [];
      for(let i=0;i<100;i++){
        const v = pad2(i), c = freq.get(v)||0;
        if(c>0) rows.push({v, c, p: n? c/n:0, hit: c>=minTimes});
      }
      rows.sort((a,b)=>Number(a.v)-Number(b.v));
      const result = rows.filter(r=>r.hit).map(r=>r.v);
      const ps = rows.map(r=>r.p).sort((a,b)=>a-b);
      const med = ps.length ? (ps.length%2? ps[(ps.length-1)/2] : (ps[ps.length/2-1]+ps[ps.length/2])/2) : 0;
      return { n, rows, result, med };
    }

    function render({n, rows, result, med}, minTimes){
      kpiN.textContent = n;
      kpiMin.textContent = minTimes;
      kpiHit.textContent = result.length;
      kpiMed.textContent = n? Math.round(med*10000)/100 + '%':'–';
      out.textContent = result.length? result.join(', ') : '(không có số đạt ngưỡng)';
      $('#outCount').textContent = result.length + ' số';

      tblBody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.v}</td>
                        <td class="right">${r.c}</td>
                        <td class="right">${(r.p*100).toFixed(2)}%</td>
                        <td class="right">${r.hit? '<span class="ok">✓</span>':'<span class="warn">–</span>'}</td>`;
        tblBody.appendChild(tr);
      }
    }

    function run(){
      const sets = parse(input.value);
      const n = sets.length, thrVal = Number(thr.value);
      const rawMin = minTimesEl.value.trim();
      let minTimes = (rawMin === '') ? NaN : Number(rawMin);
      if (!Number.isFinite(minTimes) || minTimes < 1) minTimes = Math.floor(n * thrVal);
      if (minTimes > n) minTimes = n;

      const res = analyze(sets, minTimes);
      render(res, minTimes);
      run.last = { sets, minTimes, ...res };
    }

    runBtn.addEventListener('click', run);
    thr.addEventListener('change', run);
    minTimesEl.addEventListener('input', run);
    minTimesEl.addEventListener('change', run);

    copyBtn.addEventListener('click', () => {
      const st = run.last; if(!st) return;
      navigator.clipboard.writeText(st.result.join(', ')).then(()=>{
        copyBtn.textContent='Đã copy'; setTimeout(()=>copyBtn.textContent='Copy dàn kết quả',900);
      });
    });

    csvBtn.addEventListener('click', () => {
      const st = run.last; if(!st) return;
      const header = ['So','SoLan','TiLe','DatNguong'];
      const lines = [header.join(',')];
      for(const r of st.rows){ lines.push([r.v, r.c, (st.n? (r.c/st.n):0).toFixed(4), r.c>=st.minTimes?1:0].join(',')); }
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href=url; a.download='tan_suat_dan.csv'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    document.addEventListener('DOMContentLoaded', run);
  </script>
</body>
</html>
